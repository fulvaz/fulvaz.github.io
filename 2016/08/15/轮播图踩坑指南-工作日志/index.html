<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="author" content="Fulvaz"><meta name="description" content="我只是个混github连击的"><title>轮播图踩坑指南 (工作日志) | Fulvaz PlayGroud</title><link href="/favicon.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Fulvaz PlayGroud" type="application/atom.xml"><link href="http://fonts.lug.ustc.edu.cn/css?family=Open+Sans:400" rel="stylesheet"><link href="http://fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro:400,600" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/stylesheets/app.css"></head><body><nav class="slide-menu"><div class="container"><div id="slide-introduction"><section id="slide-avator"></section><section id="slide-name"><p>Fulvaz</p></section><section id="slide-introduction-content"><p>半路出家伪文艺码农</p></section><section id="slide-contacts"></section></div><ul><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li><li><a href="https://github.com/subuta/hexo-jade-sass-barebone">Source</a></li></ul></div></nav><section id="top-head"><div id="top-head-wraper"><a href="/">Fulvaz PlayGroud</a><i id="top-head-menu-button" aria-hidden="true" class="fa fa-bars"></i></div></section><div class="wrapper"><header id="page-header"><div class="header-background-container"><video loop="true" mute="true" autoplay="true" poster="http://7xp7jw.com1.z0.glb.clouddn.com/myTheme/static/images/header-background.jpg" class="header-background-video"><source src="http://7xp7jw.com1.z0.glb.clouddn.com/myTheme/static/videos/Blurry-Lights.webm" type="video/webm"><source src="http://7xp7jw.com1.z0.glb.clouddn.com/myTheme/static/videos/Blurry-Lights.mp4" type="video/mp4"><source src="http://7xp7jw.com1.z0.glb.clouddn.com/myTheme/static/videos/Blurry-Lights.ogv" type="video/ogv"></video></div><div class="header-background-shelter"></div><div id="masthead"><div class="wrapper"><h1 id="site-title">Fulvaz PlayGroud</h1><p id="description">我只是个混github连击的</p></div></div></header><section id="content"><article class="post"><div class="article-head"><h2 class="article-title">轮播图踩坑指南 (工作日志)</h2><div class="meta article-date">2016-08-15</div></div><div class="article-content markdown-body"><p><p>好吧, 我终于变回了一个普通码农, 谢天谢地.</p>
<p>repo: <a href="https://github.com/fulvaz/Carousel-Exercises" target="_blank" rel="external">https://github.com/fulvaz/Carousel-Exercises</a></p>
<p>具体效果看淘宝首页的轮播图</p>
<p>总算是写完了一个轮播图, 回想上次面试被人鄙视轮播图都写不好, 我明白了是为什么 —- 真的轮播图都写不好, 基础太差了.</p>
<p>因为一个轮播图就能涉及到许多问题了, 下面一个个来说明</p>
<a id="more"></a>
<h2 id="设计-降低耦合"><a href="#设计-降低耦合" class="headerlink" title="设计, 降低耦合"></a>设计, 降低耦合</h2><p>如果不加任何设计直接写, 结果就是全局变量满天飞, 不同的view之间糅杂到一块, 要想办法将他们分开.</p>
<p>ps: 虽说是设计, 但是我依旧觉得还是可以继续改进.</p>
<p>到我这其实只是做了个监听者模式, 将页面逻辑和业务逻辑分离, 顺便说一下这里的页面逻辑是指与页面操作相关的逻辑, 比如说div位置, 动画, 形变等等; 业务逻辑是指, 用户点击了什么, 键盘做了什么操作</p>
<p>那接下来实现就很简单, 先实现一个监听者, 代码见.</p>
<p><a href="https://github.com/fulvaz/Carousel-Exercises/blob/master/scripts/observer.js" target="_blank" rel="external">https://github.com/fulvaz/Carousel-Exercises/blob/master/scripts/observer.js</a></p>
<p>来来回回就那么几个, 订阅, 取消订阅, 发射事件.</p>
<p>然后新建imgView, buttonView, 并且继承这个监听者, view只要监听事件, 然后处理用户点击时, emmit这个事件就可以了. </p>
<p>相比而言, 以前需要在处理click事件时还要处理页面逻辑, 不妥.</p>
<p>举个例子, 我刚开始希望只是点击左右导航, 然后图片相应切换, 没问题, 很容易.</p>
<p>那么我加这么个需求, 图片下面需要显示一排按钮, 点那个出哪个图片, 并且这排按钮还要通过高亮某个按钮, 指示现在是第几张图片.</p>
<p>这就日了狗了了啊, 刚才只是两个实体的单向联系:navigator -&gt; imgView, 现在变成了三个实体navigator, imgView, button, 而且联系有navigator-&gt;imgView, navigator-&gt;button, button-&gt;imgView</p>
<p>最麻烦的是navigator-&gt;button, 你要在原理navigator中修改原来的逻辑, 原来不需要知道第几张, 现在需要了, 要重新处理循环滚动的问题, blablabla</p>
<p>如果要再加新功能…..联系更多的话…… </p>
<p>所以还不如让他们只是负责自己的工作, 做完传个消息出去.</p>
<p>话说回来, 这个监听者模式其实是同步监听模式, 即如果在监听某个时间加入耗时操作, 直接页面被艹翻, 嗯, 异步? 说起来, 我深深感觉异步是个陨石坑…和多线程一样…</p>
<h2 id="异步问题"><a href="#异步问题" class="headerlink" title="异步问题"></a>异步问题</h2><p>我实现循环轮播, 有动画, 并且最后一张到第一张的动画无缝(实现不好就会出现最后一张绕了一大圈回到第一张的情况)</p>
<p>原理很简单, 比如需要播5张图, 将他们命名为1…5,  实现无缝循环的方法就是在1前面加一张最后一张, 在5后加入第一张, 顺序就会变成[5, 1, 2, 3, 4, 5, 1], 记这个数组为a.</p>
<p>当处于最后一张5(a[5]), 点击下一张, 那么就是到1(a[6]), 动画是5-&gt;1, 不这样, 动画效果是5-&gt;4-&gt;3-&gt;2-&gt;1</p>
<p>动画解决了, 动画后, 只需要将a[6]无动画切到a[1]就可以了(直接修改left值). </p>
<p>然后就踩到异步的坑里面去了.</p>
<p>我刚开始是利用css的transition属性做的, 那简单对吧<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">container</span>.style.left = XX; <span class="comment">// 移动到目标位置</span></div><div class="line"><span class="keyword">container</span>.classList.remove(<span class="string">'animiate'</span>); <span class="comment">// 关掉动画</span></div><div class="line"><span class="keyword">if</span> (到了a[<span class="number">6</span>])</div><div class="line">contianer.style.left = XX; <span class="comment">// 位置改到a[1]</span></div><div class="line"><span class="keyword">container</span>.classList.add(<span class="string">'animate'</span>); <span class="comment">// 开动画</span></div></pre></td></tr></table></figure></p>
<p>问题是, 修改style在浏览器是异步的啊, 而且会打包给你做</p>
<p>就是说, 你以为人家会乖乖给你按顺序做代码写的, 实际浏览器给你做的是<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">contianer.style.left = XX; <span class="comment">// 位置改到a[1]</span></div><div class="line"><span class="keyword">container</span>.classList.add(<span class="string">'animate'</span>); <span class="comment">// 开动画</span></div></pre></td></tr></table></figure></p>
<p>只有这两.</p>
<p>异步编程保证顺序的方法就是回调, css的动画的回调?</p>
<p>好吧, 我还是乖乖用requestAnimationFrame<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">offset = <span class="built_in">parseInt</span>(offset);</div><div class="line"><span class="keyword">var</span> start = <span class="literal">null</span>;</div><div class="line"><span class="keyword">var</span> <span class="keyword">from</span> = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.getComputedStyle(target).left);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">ts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!start) start = ts;</div><div class="line">    <span class="keyword">var</span> process = ts - start;</div><div class="line">    <span class="keyword">var</span> distance;</div><div class="line">    <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) &#123;</div><div class="line">        distance = <span class="built_in">Math</span>.min(process * speed, offset);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        distance = -<span class="built_in">Math</span>.min(process * speed, -offset);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    target.style.left = <span class="keyword">from</span> + distance + <span class="string">'px'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (process * speed &lt; <span class="built_in">Math</span>.abs(offset)) &#123;</div><div class="line">        <span class="built_in">window</span>.animateId = <span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(callback) &#123;</div><div class="line">        <span class="comment">// 动画结束, 运行回调函数</span></div><div class="line">        callback();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div></pre></td></tr></table></figure></p>
<p>关键点是注释那, 其他代码都是常见的用法.</p>
<h2 id="动画只有一半-图片只动了一半"><a href="#动画只有一半-图片只动了一半" class="headerlink" title="动画只有一半, 图片只动了一半"></a>动画只有一半, 图片只动了一半</h2><p>因为按太快了, 有些糟糕的教程说是内存问题, 不能按太快 (题外话, 慕课网上的前端教程糟糠多于精华, DW, 糟糕的代码风格和瞎扯, 乖乖去MDN看, 或者买书, 学习总是枯燥的)</p>
<p>我本来想加一个处理click事件延时, 比如说100ms才能按一次按钮, 但是因为和下面一个问题, 我最后用了另一个方案:</p>
<p>根本解决方法是给imgView加一个busy属性, 当他在响应某个事件时设置这个标志位, 响应结束再取消</p>
<h2 id="自动播放与点击"><a href="#自动播放与点击" class="headerlink" title="自动播放与点击"></a>自动播放与点击</h2><p>自动播放很简单, 用setTimeout就可以了(不推荐setInterval, setInterval会堆积任务 — 或者说, 产生奇怪的结果) </p>
<p>但问题来了, 如果自动播放同时快速点击下一张, 那么图片会变成空白</p>
<p>解决方法已经说了, 就是加busy属性, 但是setTimout后, 浏览器怎么处理任务?</p>
<p>首先, 我推测原因是点太快了, 首先我测试了将自动播放间隔变短, 确实直接空白, 是点太快了, 而且原因应该和循环播放有关, 从结果来看是没有重置到最开始的位置, 一直这么循环了下去</p>
<p>调试证明, 确实有时候没有运行动画后的回调.</p>
<p>推测: 是动画时间长, setTimout太短打断了动画, 所以我加快的动画速度, 确实没有问题了</p>
<p>猜测: 动画时间长, 前一个RAF重置了图片位置, 然后就被下一个RAF给改了, 嗯, 这个解释似乎最合情合理.</p>
<p>根据这个原因, 修改了一下代码, 不加busy判断也可以了.</p>
<p>原来的代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">ImgView.prototype.moveHorizontal = <span class="function"><span class="keyword">function</span>(<span class="params">target, offset, speed, callback</span>) </span>&#123;</div><div class="line">     offset = <span class="built_in">parseInt</span>(offset);</div><div class="line">     <span class="keyword">var</span> start = <span class="literal">null</span>;</div><div class="line">     <span class="keyword">var</span> <span class="keyword">from</span> = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.getComputedStyle(target).left);</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">ts</span>) </span>&#123;</div><div class="line">         <span class="keyword">if</span> (!start) start = ts;</div><div class="line">         <span class="keyword">var</span> process = ts - start;</div><div class="line">         <span class="keyword">var</span> distance;</div><div class="line">         <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) &#123;</div><div class="line">             distance = <span class="built_in">Math</span>.min(process * speed, offset); <span class="comment">// 已经移动的位移</span></div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             distance = -<span class="built_in">Math</span>.min(process * speed, -offset);</div><div class="line">         &#125;</div><div class="line"></div><div class="line"></div><div class="line">         target.style.left = <span class="keyword">from</span> + distance + <span class="string">'px'</span>;</div><div class="line">         lastDistance = distance;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (process * speed &lt; <span class="built_in">Math</span>.abs(offset)) &#123;</div><div class="line">             <span class="built_in">window</span>.animateId = <span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span>(callback) &#123;</div><div class="line">             <span class="comment">// 动画结束, 运行回调函数</span></div><div class="line">             callback();</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div><div class="line"></div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>
<p>修改后<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">ImgView.prototype.moveHorizontal = <span class="function"><span class="keyword">function</span>(<span class="params">target, offset, speed, callback</span>) </span>&#123;</div><div class="line">     offset = <span class="built_in">parseInt</span>(offset);</div><div class="line">     <span class="keyword">var</span> start = <span class="literal">null</span>;</div><div class="line">     <span class="keyword">var</span> lastDistance = <span class="number">0</span>;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">ts</span>) </span>&#123;</div><div class="line">         <span class="keyword">if</span> (!start) start = ts;</div><div class="line">         <span class="keyword">var</span> process = ts - start;</div><div class="line">         <span class="keyword">var</span> currentPos = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.getComputedStyle(target).left);</div><div class="line">         <span class="keyword">var</span> distance;</div><div class="line">         <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) &#123;</div><div class="line">             distance = <span class="built_in">Math</span>.min(process * speed, offset); <span class="comment">// 已经移动的位移</span></div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             distance = -<span class="built_in">Math</span>.min(process * speed, -offset);</div><div class="line">         &#125;</div><div class="line"></div><div class="line"></div><div class="line">         target.style.left = currentPos + distance - lastDistance + <span class="string">'px'</span>;</div><div class="line">         lastDistance = distance;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (process * speed &lt; <span class="built_in">Math</span>.abs(offset)) &#123;</div><div class="line">             <span class="built_in">window</span>.animateId = <span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span>(callback) &#123;</div><div class="line">             <span class="comment">// 动画结束, 运行回调函数</span></div><div class="line">             target.style.left = <span class="keyword">from</span> + offset + <span class="string">'px'</span>;</div><div class="line">             callback();</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="built_in">window</span>.requestAnimationFrame(handler.bind(<span class="keyword">this</span>));</div><div class="line"></div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>
<p>主要不同是, 现在每帧动画只要在现在实时位置上添加上一段距离即可</p>
<p>之前是先记录调用动画时的距离, 每帧根据那个初始距离算出新的图片位置. </p>
<p>另外callback之前还设置了一下图片的位置, 因为这么改后, 图片位置老是对不上, RAF的过程是无法debug的, 但是debug时位置是对的, 我觉得很有可能是精度被忽略的原因? 还需要研究</p>
<h2 id="moveHorizontal分析-上述解决冲突方案无效"><a href="#moveHorizontal分析-上述解决冲突方案无效" class="headerlink" title="moveHorizontal分析 (上述解决冲突方案无效)"></a>moveHorizontal分析 (上述解决冲突方案无效)</h2><p>moveHorizontal函数根据图片当前位置和接受到的offset, 然后移动图片.</p>
<p>当有多个RAF同时调用moveHorizontal时…..之前之所以没出大bug是因为offset都是一样的, 如果offset不同, 比如直接点击按钮, 刚好自动播放也要用, bug就来了</p>
<p>好吧, 上面说的解决方案其实没用.</p>
<p>需要保证同时只进行一个RAF, 就是说, 给imgView加锁 — busy属性</p>
</p></div></article></section><nav id="article-list-pagination"><a href="/2016/08/17/HTML5标准下对副标题处理建议/" title="上一页 article: HTML5标准下对副标题处理建议" class="prev">&larr; 上一页</a><a href="/2016/06/22/另一种开发环境-ubuntu-windows/" title="下一页 article: 另一种开发环境- ubuntu + windows" class="next">下一页 &rarr;</a></nav><footer id="page-footer"><nav id="footer-menu"><ul><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li><li><a href="https://github.com/fulvaz/hexo-theme">Source</a></li></ul></nav></footer></div><script src="/script/futil.min.js"></script><script src="/script/app_0.1.min.js"></script></body></html>